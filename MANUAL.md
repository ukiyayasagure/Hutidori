# ふちどり。 マニュアル

## 基本

- 以下の文章では、画像の透明度のことを「α値」と呼びます。
- 「α値」は 0（透明）～255（非透明）の値を取ります。

### 処理できる画像ファイル

- このソフトは、以下の条件に当てはまる画像ファイル（JPG, BMP, PNG, GIF）が対象です。
  - 左上 (0,0) の色を背景（透過）色とするような画像
  - 32ビット（αチャンネル + RGB）の画像
  - 「伺か」の PNA ファイルを持つ画像

### 処理の流れ

- **基本的に、ダイアログの上にあるものから順番に処理を行います。**
- つまり、「リサイズ → アンチ・アンチエイリアス → ふちどり → 出力」の順です。

### 基本的な使い方

- 処理したい画像を **1つだけ**、右上のプレビューエリアにドラッグ＆ドロップしてください。
- その後、オプションを適当にセットして **「プレビューする」** ボタンを押してください。
- 結果が気に入らない場合は、オプションを調整して再度 **「プレビューする」** を押してください。
- 結果に納得が行ったら、処理したい画像を **複数**、右下の処理エリアにドラッグ＆ドロップしてください。
  - **処理エリアにドラッグ＆ドロップすると即座に処理が行われます。ご注意ください。**
- **処理結果は元の画像に上書きされます。**
  - 元の画像を失いたくない場合は **「バックアップを残す」** にチェックを入れてください。
  - バックアップは、元の画像のファイル名に `.bak` が付いた形で保存されます。

---

## 処理詳細

### リサイズ

- リサイズを行う機能です。
- 元画像に対する縦・横の比率を％で指定してください。
- 下のドロップダウンは、拡大縮小のアルゴリズムです。
  - HQBicubic がデフォルトですが、エッジの偽色が気になる場合は **Bell**、
    ぼけが気になる場合は **Lanczos3** が適するかもしれません。

### アンチ・アンチエイリアス

- **切り捨て**：  
  「透明度しきい値」より小さい α値を持つピクセルの α値を 0 にします。
- **切り上げ**：  
  「透明度しきい値」以上の α値を持つピクセルの α値を 255 にします。
- 両方をチェックすると、半透明の領域を無くす働きをします。
- 主に画像のふちのアンチエイリアスを打ち消すため、この名前が付いています。

### ふちどり

- 画像にふちどりを行います。
- 色・透明度は、ふちの色と透明度です。
- **「元画像とふちの境界をなめらかにする」** にチェックすると、
  ふちと元画像の間に中間色が現れます。
- **「ふちの太さ」** は、大きいほどふちが太くなります  
  （その分、処理も重くなります）。
- **「ふち打ち切りしきい値」** は、
  ふちの外縁がぼけているのが気に入らない場合に大きくしてください。  
  大きくするほどシャープになりますが、ジャギーが目立ちます。

### ふちどりの上級者向けオプション

- **「ガウシアンフィルタ」「移動平均フィルタ」**  
  ふちのぼけ味を決める方法です。
  - ガウシアンフィルタの方が、ややシャープになります。
- **「ウィンドウ」**  
  ぼけの量を決める値です。
  - 大きいほどぼけますが、  
    **ウィンドウ値の二乗に比例して処理が重くなります。**  
    例：ウィンドウ30は、ウィンドウ3の100倍の処理負荷。
- **「σ」**  
  ぼけの分散を決める値です。  
  ガウシアンフィルタ使用時のみ有効です。
- **「元画像の色を完全に残す」**  
  元画像全体が半透明な場合など、特殊な状況で使用します。

### 出力方法

- **32ビットPNG**  
  αチャンネル付き 32bpp PNG 形式で保存します。
- **24ビットPNG**  
  「背景色」に指定した色で背景を塗った 24bpp PNG 形式で保存します。  
  同時に、αチャンネルのみを  
  `画像ファイル名.pna` として白黒画像で保存します。
  - **「PNA不要の場合は作らない」** にチェックすると、  
    半透明が無い場合（α値が 0 / 255 のみ）には `.pna` を作成しません。

### その他

- **「レイヤードウィンドウ（透明）で見る」**  
  背景透過ウィンドウで結果を表示します。
  - マウスドラッグで移動可能
  - ダブルクリックで閉じます
- チェックを外すと、通常のウィンドウ表示になります。
  - ダブルクリックで背景色が変わります。
- **「バックアップを残す」**  
  元画像および PNA に `.bak` を付けて保存します。
- **「このプログラムについて」**  
  バージョン情報などを表示します。

---

## 参考

### 応用例

- アンチ・アンチエイリアスのみ使用すると、  
  PNA を処理できない環境向け画像が作れます。
- リサイズ + アンチ・アンチエイリアスで、  
  簡易シェル縮小器として使用できます。
  - `surfaces.txt` までは処理できません。
- 出力を 24ビットPNG + PNA にすることで、  
  32ビット画像から PNG / PNA を作成する用途にも使えます。

### ふちどり処理のロジック

- 元画像に「ふちの太さ」回数分、ぼかしフィルタを適用し、
  それをふち色・透明度で塗ったものを **ふちレイヤー** とします。
- その上に元画像を重ねます。
- **「元画像とふちの境界をなめらかにする」**  
  元画像を1回だけぼかしたレイヤーを中間に挟みます。
- **「元画像の色を完全に残す」**  
  元画像の α値をそのまま使用し、色合成を行いません。
- **「ふち打ち切りしきい値」**  
  しきい値以下の α値を持つピクセルを透明に切り捨てます。
